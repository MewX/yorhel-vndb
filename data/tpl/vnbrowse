<h2>[[: $p{PageTitle} ]]</h2>


[[ if($d{chr} eq 'search') { ]]
 <form id="vsearch" method="get" action="/v/search" accept-charset="UTF-8">
  <fieldset>
   <input type="text" name="q" id="q" value="[[: $p{searchquery} ]]" class="text"
   /><input type="submit" value="Search!" />
   <br />
   <b id="adsearchclick">[[= !$p{searchquery} ? '&#9662;' : '&#9656;' ]]- advanced options</b>
  </fieldset>
 </form>

 <div id="adsearch" [[= !$p{searchquery} ? '' : ' style="display: none"' ]]>
  <b>Categories</b> (boolean and, selecting more gives less results)
  <ul id="cat">
  [[ for my $c (qw| e g t p h l s |) { ]]-
   -[[= $c !~ /[thl]/ ? '<li>' : '<br />' ]][[: $VNDB::CAT->{$c}[0] ]]-
   <ul>
    [[ for (sort keys %{$VNDB::CAT->{$c}[1]}) { my $ca = $c.$_; ]]-
    <li id="cat_[[= $ca ]]">
     [[: $VNDB::CAT->{$c}[1]{$_} ]]- ([[= $d{cat}{$ca} || 0 ]])</li>
    [[ } ]]
   </ul>[[= $c !~ /[gph]/ ? '</li>' : '' ]]-
  [[ } ]]-
  </ul>
  <br style="clear: both" />
  <br />
 
  <b>Languages</b> (boolean or, selecting more gives more results)<br />
  <ul class="filter" id="lfilter">
  [[ for (sort keys %{$d{langc}}) { next if !$d{langc}{$_}; my $l=$_; ]]-
   <li><input type="checkbox" name="lang_[[= $l ]]" id="lang_[[= $l ]]" value="[[: $VNDB::LANG->{$l} ]]" />
    <label for="lang_[[= $l ]]"><acronym class="icons lang -[[= $l ]]" title="[[: $VNDB::LANG->{$l} ]]">&nbsp;</acronym>([[= $d{langc}{$l} ]])</label></li>
  [[ } ]]-
  </ul>
  <br style="clear: both" />
  <br />
 
  <b>Platforms</b> (boolean or, selecting more gives more results)<br />
  <ul class="filter" id="pfilter">
  [[ for (sort keys %$VNDB::PLAT) { next if /oth/; my $l=$_; ]]-
   <li><input type="checkbox" name="plat_[[= $l ]]" id="plat_[[= $l ]]" value="[[: $VNDB::PLAT->{$l} ]]" />
    <label for="plat_[[= $l ]]"><acronym class="icons -[[= $l ]]" title="[[: $VNDB::PLAT->{$l} ]]">&nbsp;</acronym></label></li>
  [[ } ]]-
  </ul>
  <br style="clear: both" />
  <input type="button" class="right" id="vsearch_sub" name="vsearch_sub" value="Search!" />
  <br style="clear: left" />
  <br /><br />
 </div>

[[ } else { ]]-
<p class="chr">
 -[[= $d{chr} ne 'all' ? '<a href="/v/all">all</a>' : 'all' ]]- |
 [[ for('a'..'z', 0) { ]]-
 -[[ if($d{chr} eq $_) { ]][[= $_?$_:'#' ]][[ } else { ]]<a href="/v/[[= $_ ]]">[[= $_?$_:'#' ]]</a>[[ } ]]
 [[ } ]]-
 <br /><br />
</p>
[[ } ]]-


-[[ if($#{$d{vn}} < 0) { ]]
 -[[ if($d{chr} eq 'search' && $p{searchquery} || $d{chr} ne 'search') { ]]
<p>
 No results again, life sucks... :'(
</p>
 [[ } ]]
[[ } else {
  my %url = (
    $p{searchquery} ? ( q => $p{searchquery} ) : (),
  );
  my %urls = ( %url,
    $d{order}[0] ne 'title' ? ( s => $d{order}[0] ) : (),
    $d{order}[1] ne 'a' ? ( o => $d{order}[1] ) : (),
  );
  my $url = sprintf '/v/%s', $d{chr};
  my $urls = $url;
  $urls .= '?'.join(';', map { $_.'='.$urls{$_} } keys %urls) if keys %urls;
  $url  .= '?'.join(';', map { $_.'='.$url{$_} } keys %url) if keys %url;
]]

[[= pagebut($urls) ]]
<table id="tbv">
 <thead><tr>
  <td class="tc1">Title [[= sortbut($url, 'title') ]]</td>
  <td class="tc2">&nbsp;</td>
  <td class="tc3">&nbsp;</td>
  <td class="tc4">Released [[= sortbut($url, 'released') ]]</td>
  <td class="tc5">Rating [[= sortbut($url, 'votes') ]]</td>
 </tr></thead>
 [[ for (@{$d{vn}}) {
  $_->{c_votes} =~ s#^([0-9]{2}.[0-9]{2})\|([0-9]{4})$#$1 == 0 ? sprintf '- (%d)', $2 : sprintf '%.2f (%d)', $1, $2#e;
  $_->{c_released} =~ s#^([0-9]{4})([0-9]{2}).+#$1==0?'N/A':$1==9999?'TBA':(($2&&$2<13?($Time::CTime::MoY[$2-1].' '):'').$1)#e;
  $_->{c_platforms} = join '', map {
    $_ ne 'oth' ? '<acronym class="icons '.$_.'" title="'._hchar($VNDB::PLAT->{$_}).'">&nbsp;</acronym>' : ()
  } split /\//, $_->{c_platforms};
  $_->{c_languages} = join '', map qq|<acronym class="icons lang $_" title="$$VNDB::LANG{$_}">&nbsp;</acronym>|, reverse sort split /\//, $_->{c_languages};
 ]]-
 <tr>
  <td class="tc1"><a href="/v[[= $_->{id} ]]" title="[[: $_->{title} ]]">[[: shorten $_->{title}, 50 ]]</a></td>
  <td class="tc2">[[= $_->{c_platforms} ]]</td>
  <td class="tc3">[[= $_->{c_languages} ]]</td>
  <td class="tc4">[[: $_->{c_released} ]]</td>
  <td class="tc5">[[: $_->{c_votes} ]]</td>
 </tr>
 [[ } ]]-
</table>
[[= pagebut($urls) ]]
[[ } ]] 
